<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBay Listing Assistant</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { font-family: 'Noto Sans KR', sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f4f6f8; color: #333; }
        h1 { text-align: center; color: #005fbc; margin-bottom: 30px; }
        
        /* íƒ­ ë©”ë‰´ */
        .tab-menu { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 15px; cursor: pointer; text-align: center; font-weight: bold; font-size: 16px; color: #666; background: #eee; border: none; border-radius: 8px 8px 0 0; margin-right: 2px; transition: 0.3s; }
        .tab-btn:hover { background: #e0e0e0; }
        .tab-btn.active { background: #005fbc; color: white; }
        
        .tab-content { display: none; background: white; padding: 30px; border-radius: 0 0 8px 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }

        /* ì…ë ¥/ì¶œë ¥ ìš”ì†Œ */
        textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 13px; resize: vertical; box-sizing: border-box; }
        button { background-color: #005fbc; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 15px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background-color: #004c99; }
        .copy-btn { background: #666; font-size: 12px; padding: 5px 10px; margin-left: 10px; }

        /* Step 1 OCR ìŠ¤íƒ€ì¼ */
        .upload-box { border: 2px dashed #ccc; padding: 30px; text-align: center; border-radius: 8px; margin-bottom: 20px; cursor: pointer; transition: 0.3s; background: #fafafa; }
        .upload-box:hover { border-color: #005fbc; background-color: #f0f7ff; }
        #ocrStatus { margin: 10px 0; font-weight: bold; color: #005fbc; text-align: center; min-height: 20px; }
        .progress-bar { width: 100%; background-color: #e0e0e0; border-radius: 4px; overflow: hidden; height: 10px; margin-bottom: 20px; display: none; }
        .progress-fill { height: 100%; background-color: #4caf50; width: 0%; transition: width 0.3s; }

        /* Step 2 ì¡°ë¦½ê¸° ìŠ¤íƒ€ì¼ */
        .assembler-container { display: flex; gap: 20px; }
        .left-panel { flex: 1; }
        .right-panel { flex: 1.5; border-left: 1px solid #eee; padding-left: 20px; }
        .result-group { margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px; background: #fafafa; }
        .result-label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f0f7ff; width: 30%; }
        
        /* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .file-upload-area { background: #e8f4fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #b3d9ff; display: flex; align-items: center; justify-content: space-between; }
        .file-upload-area h4 { margin: 0; color: #005fbc; display: flex; align-items: center; }

        /* í•˜ë‹¨ í‘¸í„° (ë²„ì „ ì •ë³´) */
        .footer-info {
            text-align: right;
            margin-top: 50px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            color: #888;
            font-size: 12px;
            font-weight: bold;
        }
        
        @media (max-width: 768px) { .assembler-container { flex-direction: column; } .right-panel { border-left: none; padding-left: 0; border-top: 1px solid #eee; padding-top: 20px; } }
    </style>
</head>
<body>

<h1>eBay Listing Assistant</h1>

<div class="tab-menu">
    <button class="tab-btn active" onclick="openTab('step1')">Step 1. í…ìŠ¤íŠ¸ ì¶”ì¶œ (OCR)</button>
    <button class="tab-btn" onclick="openTab('step2')">Step 2. ë¦¬ìŠ¤íŒ… ìƒì„± (JSON)</button>
</div>

<div id="step1" class="tab-content active">
    <h2 style="margin-top:0;">ğŸ“· ì´ë¯¸ì§€ í…ìŠ¤íŠ¸ ì¶”ì¶œ (ë‹¤ì¤‘ íŒŒì¼ ì§€ì›)</h2>
    
    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
        <p>ğŸ“ <strong>ì œí’ˆ ì´ë¯¸ì§€ë“¤(ìµœëŒ€ 20ì¥)</strong>ì„ í•œ ë²ˆì— ì—…ë¡œë“œí•˜ì„¸ìš”</p>
        <input type="file" id="fileInput" accept="image/*" multiple style="display: none;" onchange="processImages(this)">
    </div>

    <div style="margin-bottom: 5px; font-weight: bold; color: #555;">ğŸ“ í‚¤ì›Œë“œ, ì œí’ˆëª…</div>
    <textarea id="userPrompt" style="height: 100px; margin-bottom: 20px; background-color: #fffde7; border: 1px solid #e6db74;" placeholder="ì˜ˆ) ì•„ë˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ eBay ë¦¬ìŠ¤íŒ… ì œëª©ê³¼ ì„¤ëª…ì„ ì˜ì–´ë¡œ ì‘ì„±í•´ì¤˜."></textarea>

    <div id="ocrStatus">ëŒ€ê¸° ì¤‘...</div>
    <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
    
    <div style="margin-bottom: 5px; font-weight: bold; color: #555;">ğŸ“„ ì¶”ì¶œëœ í…ìŠ¤íŠ¸</div>
    <textarea id="resultText" style="height: 300px;" placeholder="ì´ë¯¸ì§€ì—ì„œ ì¶”ì¶œëœ í…ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— ìˆœì°¨ì ìœ¼ë¡œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤..."></textarea>
    
    <div style="margin-top: 10px; text-align: right;">
        <button onclick="copyCombinedText()" style="background-color: #2e7d32;">ğŸ“‹ ì „ì²´ ë³µì‚¬</button>
    </div>
</div>

<div id="step2" class="tab-content">
    <h2 style="margin-top:0;">ğŸ› ï¸ ë¦¬ìŠ¤íŒ… ë°ì´í„° ì¡°ë¦½</h2>
    
    <div class="file-upload-area">
        <div>
            <h4 style="margin-bottom: 5px;">ğŸ“‚ 1. ë² ì´ìŠ¤ HTML í…œí”Œë¦¿ ì—…ë¡œë“œ</h4>
            <span style="font-size: 12px; color: #666;">* 'REPLACE THIS SECTION...' ì£¼ì„ì´ í¬í•¨ëœ íŒŒì¼</span>
        </div>
        <input type="file" id="templateFileInput" accept=".html">
    </div>

    <div class="assembler-container">
        <div class="left-panel">
            <h4>ğŸ‘‡ 2. Gemsê°€ ì¤€ JSON ë¶™ì—¬ë„£ê¸°</h4>
            <textarea id="jsonInput" style="height: 400px;" placeholder='{
  "titles": {...}, 
  "item_specifics": {...},
  "description_html": "...",
  "caution": [...]
}'></textarea>
            <br><br>
            <button onclick="generateListing()" style="width:100%;">ğŸš€ ë¦¬ìŠ¤íŒ… ìƒì„±í•˜ê¸°</button>
        </div>

        <div class="right-panel">
            <div id="outputArea" style="display:none;">
                <div class="result-group">
                    <span class="result-label">Title Option A <button class="copy-btn" onclick="copyText('titleA')">ë³µì‚¬</button></span>
                    <input type="text" id="titleA" style="width:100%; padding:8px;" readonly>
                </div>
                <div class="result-group">
                    <span class="result-label">Title Option B <button class="copy-btn" onclick="copyText('titleB')">ë³µì‚¬</button></span>
                    <input type="text" id="titleB" style="width:100%; padding:8px;" readonly>
                </div>
                <div class="result-group">
                    <span class="result-label">Item Specifics (Check Only)</span>
                    <table id="specsTable"></table>
                </div>
                <div class="result-group">
                    <span class="result-label">ğŸ”¥ HTML Full Code <button class="copy-btn" onclick="copyText('finalHtml')">ì½”ë“œ ë³µì‚¬</button></span>
                    <textarea id="finalHtml" style="height: 300px; color: #005fbc; font-weight: bold;"></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="footer-info">
    Ver. 1.1
</div>

<script>
    // íƒ­ ì „í™˜ í•¨ìˆ˜
    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // í…ìŠ¤íŠ¸ ë³µì‚¬ í•¨ìˆ˜ (ë‹¨ì¼ ìš”ì†Œ)
    function copyText(elementId) {
        const copyText = document.getElementById(elementId);
        copyText.select();
        document.execCommand("copy");
    }

    // [ì¶”ê°€] ì§€ì‹œë¬¸ + OCR ê²°ê³¼ í•©ì³ì„œ ë³µì‚¬í•˜ê¸°
    function copyCombinedText() {
        const prompt = document.getElementById('userPrompt').value;
        const result = document.getElementById('resultText').value;

        if (!result && !prompt) {
            alert("ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const combinedText = prompt + "\n\n" + result;

        const tempElem = document.createElement('textarea');
        tempElem.value = combinedText;
        document.body.appendChild(tempElem);
        tempElem.select();
        document.execCommand("copy");
        document.body.removeChild(tempElem);

        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = "âœ… ë³µì‚¬ ì™„ë£Œ!";
        btn.style.backgroundColor = "#4caf50";
        setTimeout(() => {
            btn.innerText = originalText;
            btn.style.backgroundColor = "#2e7d32";
        }, 1500);
    }

    // ================= STEP 1: OCR Logic (ë‹¤ì¤‘ ì´ë¯¸ì§€ ì§€ì›) =================
    function loadImage(file) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.src = URL.createObjectURL(file);
            img.onload = () => resolve(img);
            img.onerror = (e) => reject(e);
        });
    }

    async function processImages(input) {
        if (!input.files || input.files.length === 0) return;
        
        const maxFiles = 20;
        let files = Array.from(input.files);
        if (files.length > maxFiles) {
            alert(`ì´ë¯¸ì§€ëŠ” ìµœëŒ€ ${maxFiles}ì¥ê¹Œì§€ë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.\nì„ íƒí•˜ì‹  íŒŒì¼ ì¤‘ ì•ìª½ ${maxFiles}ì¥ë§Œ ì§„í–‰í•©ë‹ˆë‹¤.`);
            files = files.slice(0, maxFiles);
        }

        const status = document.getElementById('ocrStatus');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const resultArea = document.getElementById('resultText');
        
        resultArea.value = "";
        progressBar.style.display = 'block';
        progressFill.style.width = '0%';
        
        let fullResultText = "";
        
        status.innerText = "OCR ì—”ì§„ ì´ˆê¸°í™” ì¤‘...";
        const worker = await Tesseract.createWorker('kor'); 

        try {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileNum = i + 1;
                status.innerText = `[${fileNum}/${files.length}] ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘... (${file.name})`;
                
                const img = await loadImage(file);
                
                const sliceHeight = 1500; 
                const totalSlices = Math.ceil(img.height / sliceHeight);
                
                let fileText = `\n=== [Image ${fileNum}: ${file.name}] ===\n`;

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;

                for (let j = 0; j < totalSlices; j++) {
                    const y = j * sliceHeight;
                    const h = Math.min(sliceHeight, img.height - y);
                    
                    canvas.height = h;
                    ctx.drawImage(img, 0, y, img.width, h, 0, 0, img.width, h);
                    
                    const { data: { text } } = await worker.recognize(canvas);
                    fileText += text + "\n";
                    
                    const currentFileProgress = (j + 1) / totalSlices;
                    const totalProgress = ((i + currentFileProgress) / files.length) * 100;
                    progressFill.style.width = `${totalProgress}%`;
                }
                
                fullResultText += fileText + "\n";
                resultArea.value = fullResultText;
                resultArea.scrollTop = resultArea.scrollHeight;
            }
            
            status.innerText = `âœ… ì´ ${files.length}ì¥ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ!`;
            
        } catch (e) {
            console.error(e);
            status.innerText = "âŒ ì˜¤ë¥˜ ë°œìƒ: " + e.message;
            alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        } finally {
            await worker.terminate();
        }
    }

    // ================= STEP 2: Assembler Logic =================
    async function generateListing() {
        const jsonStr = document.getElementById('jsonInput').value;
        const templateFile = document.getElementById('templateFileInput').files[0];

        if (!templateFile) { alert("ë¨¼ì € 'ë² ì´ìŠ¤ HTML í…œí”Œë¦¿' íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!"); return; }
        if (!jsonStr) { alert("JSON ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”!"); return; }

        try {
            const data = JSON.parse(jsonStr);
            
            // (1) íƒ€ì´í‹€ ì±„ìš°ê¸°
            document.getElementById('titleA').value = data.titles.option_a || "";
            document.getElementById('titleB').value = data.titles.option_b || "";

            // (2) ìŠ¤í™ í…Œì´ë¸” ìƒì„± (í™•ì¸ìš©)
            let tableRows = "";
            for (const key in data.item_specifics) {
                if (data.item_specifics.hasOwnProperty(key)) {
                    const specKey = key || "Feature";
                    const specValue = data.item_specifics[key] || "N/A";
                    tableRows += `<tr><th>${specKey}</th><td>${specValue}</td></tr>`;
                }
            }
            document.getElementById('specsTable').innerHTML = tableRows;
            
            // (3) ì£¼ì˜ì‚¬í•­(Caution) ìƒì„±
            let cautionHtmlBlock = "";
            if (data.caution && data.caution.length > 0) {
                cautionHtmlBlock = `<div style="margin-top: 25px; background: #fff5f5; padding: 15px; border-radius: 8px;">
                    <h4 style="color: #d9534f; margin-top:0;">âš ï¸ Caution</h4>
                    <ul style="color: #555; padding-left: 20px; margin-bottom: 0;">
                        ${data.caution.map(c => `<li>${c}</li>`).join('')}
                    </ul>
                </div>`;
            }

            // (4) AI ë§ˆì¼€íŒ… ì„¤ëª… (HTML) ê°€ì ¸ì˜¤ê¸°
            const marketingHtml = data.description_html || "<p>ìƒì„¸ ì„¤ëª… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";

            // (5) ìµœì¢… ì½˜í…ì¸  í•©ì²´
            const fullContentBlock = marketingHtml + cautionHtmlBlock;

            // (6) íŒŒì¼ ì½ê¸° ë° ì¡°ë¦½
            const reader = new FileReader();
            reader.onload = function(e) {
                let templateHtml = e.target.result;
                const marker = "<!-- REPLACE THIS SECTION WITH PRODUCT-SPECIFIC CONTENT -->";

                if (templateHtml.includes(marker)) {
                    const finalCode = templateHtml.replace(marker, fullContentBlock);
                    
                    document.getElementById('finalHtml').value = finalCode;
                    document.getElementById('outputArea').style.display = 'block';
                } else {
                    alert("âš ï¸ ì˜¤ë¥˜: í…œí”Œë¦¿ íŒŒì¼ì—ì„œ ì•½ì†ëœ ì£¼ì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n'' \n\nì´ ë¬¸ì¥ì´ HTML íŒŒì¼ ì•ˆì— ë“¤ì–´ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
                }
            };
            reader.readAsText(templateFile);

        } catch (e) {
            alert("âŒ JSON íŒŒì‹± ì˜¤ë¥˜!\nGemsê°€ ì¤€ JSON ë°ì´í„° í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.\n\nì˜¤ë¥˜ ë‚´ìš©: " + e.message);
        }
    }
</script>

</body>
</html>
